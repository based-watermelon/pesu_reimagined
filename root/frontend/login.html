<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PESU Reimagined — Login</title>
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --cream:        #0E0A1A;
  --amber:        #A855F7;
  --amber-light:  #C084FC;
  --amber-dark:   #7C3AED;
  --warm-brown:   #C4B5FD;
  --text:         #F0EAFF;
  --text-muted:   #8B7BA8;
  --card-bg:      rgba(20,12,40,0.84);
  --shadow:       0 8px 48px rgba(0,0,0,0.55);
  --border:       rgba(168,85,247,0.2);
}

html, body {
  height: 100%;
  font-family: 'DM Sans', sans-serif;
  background: var(--cream);
  overflow: hidden;
}

.bg {
  position: fixed; inset: 0; z-index: 0;
  background:
    radial-gradient(ellipse 120% 80% at 20% 20%, #1E1040 0%, transparent 55%),
    radial-gradient(ellipse 90% 90% at 80% 80%, #2A1060 0%, transparent 50%),
    radial-gradient(ellipse 70% 60% at 50% 50%, #160830 0%, transparent 60%),
    #0E0A1A;
}
.blob {
  position: absolute; border-radius: 50%;
  filter: blur(55px); opacity: 0.55;
  animation: drift linear infinite;
}
.blob1 { width:420px; height:420px; background:#4C1D95; top:-100px; left:-120px; animation-duration:22s; }
.blob2 { width:300px; height:300px; background:#6D28D9; bottom:-80px; right:-60px; animation-duration:18s; animation-delay:-6s; }
.blob3 { width:200px; height:200px; background:#A855F733; top:40%; left:55%; animation-duration:26s; animation-delay:-12s; }

@keyframes drift {
  0%   { transform: translate(0,0) scale(1); }
  33%  { transform: translate(30px,-40px) scale(1.05); }
  66%  { transform: translate(-20px,25px) scale(0.97); }
  100% { transform: translate(0,0) scale(1); }
}

.particles { position:fixed; inset:0; z-index:1; pointer-events:none; overflow:hidden; }
.particle {
  position:absolute; border-radius:50%; background:var(--amber); opacity:0;
  animation: float-up linear infinite;
}
@keyframes float-up {
  0%   { transform:translateY(100vh) scale(0); opacity:0; }
  10%  { opacity:0.35; }
  90%  { opacity:0.15; }
  100% { transform:translateY(-10vh) scale(1); opacity:0; }
}

.page {
  position:relative; z-index:2;
  min-height:100vh;
  display:flex; align-items:center; justify-content:center;
  padding:24px;
}

.card {
  background: var(--card-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(168,85,247,0.22);
  border-radius: 28px;
  box-shadow: var(--shadow), 0 2px 0 rgba(255,255,255,0.04) inset;
  padding: 44px 44px 36px;
  width: 100%; max-width: 430px;
  animation: card-in 0.7s cubic-bezier(.22,.88,.36,1) both;
}
@keyframes card-in {
  from { opacity:0; transform:translateY(28px) scale(0.97); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}

.brand { text-align:center; margin-bottom:28px; }
.brand-icon {
  width:54px; height:54px;
  background: linear-gradient(135deg, var(--amber) 0%, var(--amber-dark) 100%);
  border-radius:16px;
  display:inline-flex; align-items:center; justify-content:center;
  margin-bottom:12px;
  box-shadow: 0 4px 20px rgba(168,85,247,0.4);
}
.brand-icon svg { width:26px; height:26px; fill:white; }
.brand h1 {
  font-family:'Lora', serif;
  font-size:1.6rem;
  color:var(--text);
  letter-spacing:-0.02em;
}
.brand h1 em { font-style:italic; color:var(--amber-light); }

.screen { display:none; }
.screen.active {
  display:block;
  animation: fade-in 0.32s cubic-bezier(.22,.88,.36,1) both;
}
@keyframes fade-in {
  from { opacity:0; transform:translateY(10px); }
  to   { opacity:1; transform:translateY(0); }
}

.role-prompt {
  font-size:0.75rem; font-weight:500;
  color:var(--text-muted);
  letter-spacing:0.08em; text-transform:uppercase;
  text-align:center; margin-bottom:14px;
}
.role-grid {
  display:grid; grid-template-columns:1fr 1fr;
  gap:10px;
}
.role-btn {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:8px; padding:18px 10px;
  background: rgba(168,85,247,0.05);
  border: 1.5px solid var(--border);
  border-radius:18px;
  cursor:pointer;
  transition: background 0.18s, border-color 0.18s, transform 0.14s, box-shadow 0.18s;
  text-align:center;
}
.role-btn:hover {
  background: rgba(168,85,247,0.12);
  border-color: var(--amber);
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(168,85,247,0.2);
}
.role-btn:active { transform:translateY(0); }

.role-icon {
  width:40px; height:40px; border-radius:12px;
  display:flex; align-items:center; justify-content:center; flex-shrink:0;
}
.role-icon svg { width:20px; height:20px; stroke:white; stroke-width:1.8; fill:none; }

.role-btn[data-role="student"] .role-icon { background:linear-gradient(135deg,#A855F7,#7C3AED); }
.role-btn[data-role="faculty"] .role-icon { background:linear-gradient(135deg,#6366F1,#4338CA); }
.role-btn[data-role="parent"]  .role-icon { background:linear-gradient(135deg,#EC4899,#BE185D); }
.role-btn[data-role="guest"]   .role-icon { background:linear-gradient(135deg,#10B981,#059669); }

.role-name  { font-size:0.88rem; font-weight:500; color:var(--text); line-height:1; }
.role-desc  { font-size:0.7rem; color:var(--text-muted); line-height:1.3; }

.form-header {
  display:flex; align-items:center; gap:10px; margin-bottom:20px;
}
.back-btn {
  width:32px; height:32px; border-radius:10px;
  background: rgba(168,85,247,0.08);
  border: 1px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; flex-shrink:0;
  transition: background 0.15s;
}
.back-btn:hover { background:rgba(168,85,247,0.16); }
.back-btn svg { width:15px; height:15px; stroke:var(--text-muted); stroke-width:2; fill:none; }
.form-header-text h2 { font-family:'Lora',serif; font-size:1.08rem; color:var(--text); }
.form-header-text p  { font-size:0.73rem; color:var(--text-muted); margin-top:1px; }
.role-badge {
  margin-left:auto; font-size:0.68rem; font-weight:500;
  padding:3px 9px; border-radius:99px;
  letter-spacing:0.04em; text-transform:uppercase; white-space:nowrap;
}
.badge-student { background:rgba(168,85,247,0.15); color:#C084FC; border:1px solid rgba(168,85,247,0.3); }
.badge-faculty { background:rgba(99,102,241,0.15); color:#A5B4FC; border:1px solid rgba(99,102,241,0.3); }
.badge-parent  { background:rgba(236,72,153,0.15); color:#F9A8D4; border:1px solid rgba(236,72,153,0.3); }
.badge-guest   { background:rgba(16,185,129,0.15); color:#6EE7B7; border:1px solid rgba(16,185,129,0.3); }

.form-group { margin-bottom:14px; }
label {
  display:block; font-size:0.73rem; font-weight:500;
  color:var(--warm-brown); letter-spacing:0.06em;
  text-transform:uppercase; margin-bottom:6px;
}
.input-wrap { position:relative; }
.input-wrap > svg {
  position:absolute; left:13px; top:50%; transform:translateY(-50%);
  width:15px; height:15px;
  stroke:var(--text-muted); stroke-width:1.8; fill:none;
  pointer-events:none; transition:stroke 0.2s;
}
.input-wrap:focus-within > svg { stroke:var(--amber); }

input {
  width:100%; padding:12px 13px 12px 38px;
  border:1.5px solid var(--border); border-radius:13px;
  font-family:'DM Sans',sans-serif; font-size:0.9rem;
  color:var(--text); background:rgba(255,255,255,0.05);
  transition:border-color 0.2s,box-shadow 0.2s,background 0.2s;
  outline:none;
}
input::placeholder { color:#3D2D60; }
input:focus {
  border-color:var(--amber);
  background:rgba(168,85,247,0.08);
  box-shadow:0 0 0 3px rgba(168,85,247,0.14);
}

.eye-btn {
  position:absolute; right:11px; top:50%; transform:translateY(-50%);
  background:none; border:none; cursor:pointer;
  padding:4px; display:flex; align-items:center; justify-content:center;
  border-radius:6px; transition:background 0.15s;
}
.eye-btn:hover { background:rgba(168,85,247,0.1); }
.eye-btn svg {
  width:16px; height:16px;
  stroke:var(--text-muted); stroke-width:1.8; fill:none;
  transition:stroke 0.2s; display:block;
}
.eye-btn:hover svg { stroke:var(--amber); }

.guest-info {
  background:rgba(16,185,129,0.07);
  border:1px solid rgba(16,185,129,0.2);
  border-radius:14px; padding:15px; margin-bottom:16px;
}
.guest-info p { font-size:0.82rem; color:#6EE7B7; line-height:1.6; }
.guest-info p strong { color:#A7F3D0; }

.btn {
  width:100%; padding:13px;
  background:linear-gradient(135deg,var(--amber) 0%,var(--amber-dark) 100%);
  color:white; border:none; border-radius:13px;
  font-family:'DM Sans',sans-serif; font-size:0.95rem; font-weight:500;
  cursor:pointer; letter-spacing:0.02em;
  box-shadow:0 4px 18px rgba(168,85,247,0.38),0 1px 0 rgba(255,255,255,0.1) inset;
  transition:transform 0.15s,box-shadow 0.15s,filter 0.15s;
  position:relative; overflow:hidden;
}
.btn:hover  { transform:translateY(-1px); box-shadow:0 6px 24px rgba(168,85,247,0.45); }
.btn:active { transform:translateY(0); filter:brightness(0.97); }
.btn.loading { pointer-events:none; }
.btn .btn-text { transition:opacity 0.2s; }
.btn.loading .btn-text { opacity:0; }
.btn .spinner { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; }
.btn.loading .spinner { opacity:1; }
.spinner svg { width:20px; height:20px; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }

.btn-guest {
  background:linear-gradient(135deg,#10B981,#059669);
  box-shadow:0 4px 18px rgba(16,185,129,0.3);
}
.btn-guest:hover { box-shadow:0 6px 24px rgba(16,185,129,0.4); }

.error-msg {
  background:#1A0A2E; border:1px solid #4C1D95; color:#C084FC;
  border-radius:10px; padding:9px 13px; font-size:0.81rem;
  margin-top:11px; display:none; animation:shake 0.35s ease;
}
@keyframes shake {
  0%,100% { transform:translateX(0); }
  25% { transform:translateX(-6px); }
  75% { transform:translateX(6px); }
}

.footer-note {
  text-align:center; margin-top:20px;
  font-size:0.74rem; color:var(--text-muted);
}
.footer-note span { color:var(--amber-light); font-weight:500; }
</style>
</head>
<body>

<div class="bg">
  <div class="blob blob1"></div>
  <div class="blob blob2"></div>
  <div class="blob blob3"></div>
</div>
<div class="particles" id="particles"></div>

<div class="page">
  <div class="card">

    <div class="brand">
      <div class="brand-icon">
        <svg viewBox="0 0 24 24"><path d="M12 3L2 8l10 5 10-5-10-5zM2 16l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      <h1>PESU <em>Reimagined</em></h1>
    </div>

    <div class="screen active" id="screen-role">
      <p class="role-prompt">Who are you signing in as?</p>
      <div class="role-grid">

        <button class="role-btn" data-role="student" onclick="selectRole('student')">
          <div class="role-icon">
            <svg viewBox="0 0 24 24"><path d="M22 10v6M2 10l10-5 10 5-10 5-10-5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
          </div>
          <span class="role-name">Student</span>
          <span class="role-desc">Attendance &amp; timetable</span>
        </button>

        <button class="role-btn" data-role="faculty" onclick="selectRole('faculty')">
          <div class="role-icon">
            <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
          </div>
          <span class="role-name">Faculty</span>
          <span class="role-desc">Classes &amp; student records</span>
        </button>

        <button class="role-btn" data-role="parent" onclick="selectRole('parent')">
          <div class="role-icon">
            <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <span class="role-name">Parent</span>
          <span class="role-desc">Monitor ward's progress</span>
        </button>

        <button class="role-btn" data-role="guest" onclick="selectRole('guest')">
          <div class="role-icon">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
          </div>
          <span class="role-name">Guest</span>
          <span class="role-desc">Explore without login</span>
        </button>

      </div>
    </div>

    <div class="screen" id="screen-student">
      <div class="form-header">
        <button class="back-btn" onclick="goBack()">
          <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="form-header-text">
          <h2>Student Sign In</h2>
          <p>Use your PESU SRN &amp; password</p>
        </div>
        <span class="role-badge badge-student">Student</span>
      </div>
      <div class="form-group">
        <label>SRN / Username</label>
        <div class="input-wrap">
          <input type="text" id="s-username" placeholder="e.g. PES2UG22CS001" autocomplete="username"/>
          <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>
        </div>
      </div>
      <div class="form-group">
        <label>Password</label>
        <div class="input-wrap">
          <input type="password" id="s-password" placeholder="Your PESU password" autocomplete="current-password" style="padding-right:42px"/>
          <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <button type="button" class="eye-btn" onclick="togglePwd('s-password',this)">
            <svg viewBox="0 0 24 24" class="eye-open"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg viewBox="0 0 24 24" class="eye-closed" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      </div>
      <button class="btn" id="s-loginBtn" onclick="doLogin('student')">
        <span class="btn-text">Sign in as Student</span>
        <span class="spinner"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></span>
      </button>
      <div class="error-msg" id="s-error"></div>
    </div>

    <div class="screen" id="screen-faculty">
      <div class="form-header">
        <button class="back-btn" onclick="goBack()">
          <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="form-header-text">
          <h2>Faculty Sign In</h2>
          <p>Use your faculty portal credentials</p>
        </div>
        <span class="role-badge badge-faculty">Faculty</span>
      </div>
      <div class="form-group">
        <label>Faculty ID / Email</label>
        <div class="input-wrap">
          <input type="text" id="f-username" placeholder="e.g. faculty@pes.edu" autocomplete="username"/>
          <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/></svg>
        </div>
      </div>
      <div class="form-group">
        <label>Password</label>
        <div class="input-wrap">
          <input type="password" id="f-password" placeholder="Faculty password" autocomplete="current-password" style="padding-right:42px"/>
          <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <button type="button" class="eye-btn" onclick="togglePwd('f-password',this)">
            <svg viewBox="0 0 24 24" class="eye-open"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg viewBox="0 0 24 24" class="eye-closed" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      </div>
      <button class="btn" id="f-loginBtn" onclick="doLogin('faculty')">
        <span class="btn-text">Sign in as Faculty</span>
        <span class="spinner"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></span>
      </button>
      <div class="error-msg" id="f-error"></div>
    </div>

    <div class="screen" id="screen-parent">
      <div class="form-header">
        <button class="back-btn" onclick="goBack()">
          <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="form-header-text">
          <h2>Parent Sign In</h2>
          <p>Enter your ward's SRN &amp; password</p>
        </div>
        <span class="role-badge badge-parent">Parent</span>
      </div>
      <div class="form-group">
        <label>Ward's SRN</label>
        <div class="input-wrap">
          <input type="text" id="p-username" placeholder="e.g. PES2UG22CS001" autocomplete="username"/>
          <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
      </div>
      <div class="form-group">
        <label>Password</label>
        <div class="input-wrap">
          <input type="password" id="p-password" placeholder="Ward's PESU password" autocomplete="current-password" style="padding-right:42px"/>
          <svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <button type="button" class="eye-btn" onclick="togglePwd('p-password',this)">
            <svg viewBox="0 0 24 24" class="eye-open"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg viewBox="0 0 24 24" class="eye-closed" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      </div>
      <button class="btn" id="p-loginBtn" onclick="doLogin('parent')">
        <span class="btn-text">Sign in as Parent</span>
        <span class="spinner"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></span>
      </button>
      <div class="error-msg" id="p-error"></div>
    </div>

    <div class="screen" id="screen-guest">
      <div class="form-header">
        <button class="back-btn" onclick="goBack()">
          <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
        </button>
        <div class="form-header-text">
          <h2>Guest Access</h2>
          <p>No login required</p>
        </div>
        <span class="role-badge badge-guest">Guest</span>
      </div>
      <div class="guest-info">
        <p>As a guest you can explore <strong>PESU Reimagined</strong> and ask the AI general questions about PES University — policies, attendance rules, and more.</p>
        <p style="margin-top:10px">⚠️ Personal data like attendance &amp; timetable is <strong>not available</strong> without signing in.</p>
      </div>
      <button class="btn btn-guest" onclick="enterGuest()">
        <span class="btn-text">Continue as Guest →</span>
        <span class="spinner"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></span>
      </button>
    </div>


    <div class="footer-note">
      Your data is only used within this session. <span>Never stored.</span>
    </div>

  </div>
</div>

<script>
(function() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 18; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    const size = Math.random() * 5 + 3;
    p.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;animation-duration:${Math.random()*14+10}s;animation-delay:${Math.random()*-20}s;`;
    container.appendChild(p);
  }
})();

let currentRole = null;

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

function selectRole(role) {
  currentRole = role;
  showScreen(role);
}

function goBack() {
  currentRole = null;
  showScreen('role');
}

function togglePwd(inputId, btn) {
  const input    = document.getElementById(inputId);
  const isHidden = input.type === 'password';
  input.type = isHidden ? 'text' : 'password';
  btn.querySelector('.eye-open').style.display   = isHidden ? 'none'  : 'block';
  btn.querySelector('.eye-closed').style.display = isHidden ? 'block' : 'none';
}

const prefixMap = { student:'s', faculty:'f', parent:'p' };

const endpointMap = {
  student: '/login',
  faculty: '/faculty-login',
  parent:  '/parent-login',
};

async function doLogin(role) {
  const px       = prefixMap[role];
  const username = document.getElementById(`${px}-username`).value.trim();
  const password = document.getElementById(`${px}-password`).value;
  const btn      = document.getElementById(`${px}-loginBtn`);
  const errEl    = document.getElementById(`${px}-error`);

  errEl.style.display = 'none';

  if (!username || !password) {
    showError(errEl, 'Please fill in both fields.');
    return;
  }

  btn.classList.add('loading');
  try {
    const endpoint = endpointMap[role] || '/login';
    const res  = await fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Login failed');

    sessionStorage.setItem('pesu_token', data.token);
    sessionStorage.setItem('pesu_user',  data.username);
    sessionStorage.setItem('pesu_role',  data.role);

    if (data.data) {
      sessionStorage.setItem('pesu_data', JSON.stringify(data.data));
    }

    window.location.href = '/dashboard.html';
  } catch(e) {
    showError(errEl, e.message);
  } finally {
    btn.classList.remove('loading');
  }
}

function enterGuest() {
  sessionStorage.setItem('pesu_token', 'guest');
  sessionStorage.setItem('pesu_user',  'Guest');
  sessionStorage.setItem('pesu_role',  'guest');
  window.location.href = '/dashboard.html';
}

function showError(el, msg) {
  el.textContent = msg;
  el.style.display = 'block';
  el.style.animation = 'none';
  void el.offsetWidth;
  el.style.animation = 'shake 0.35s ease';
}

document.addEventListener('keydown', e => {
  if (e.key !== 'Enter' || !currentRole || currentRole === 'guest') return;
  doLogin(currentRole);
});
</script>
</body>
</html>